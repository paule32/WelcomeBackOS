# -------------------------------------------------------------
# \file   build-windows-mingw.yml
# \author Jens Kallup - paule32.jk
# \legal  (c) 2026 all rights reserved.
#
# \nore   builds remote bootcd.iso file for IBM-PC compatibles
# -------------------------------------------------------------
name: Build Boot ISO (Windows / MSYS2 MinGW32)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

env:
  SRC_DIR: src
  ISO_PATH: build/bin/bootcd.iso
  ARTIFACT_CD_NAME: bootCD-iso

jobs:
  BootISO:              # interne ID (ohne Leerzeichen)
    name: Boot-CD ISO   # Anzeige-Name (mit Leerzeichen ok)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSYS2 (MinGW32 toolchain + required tools)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW32
          update: true
          install: >
            mingw-w64-i686-gcc
            mingw-w64-i686-binutils
            mingw-w64-i686-gdb
            make
            nasm
            xorriso
            python
            wget
            gzip
            gawk
            coreutils
            diffutils
            file
            git

      - name: Show tool versions
        shell: msys2 {0}
        run: |
          set -euxo pipefail
          gcc --version
          g++ --version
          ld --version || true
          objcopy --version
          make --version
          nasm -v
          xorriso -version
          python3 --version
          wget --version | head -n 1
          dd --version | head -n 1
          awk --version | head -n 1
          
      - name: Build-CD in MSYS2
        shell: msys2 {0}
        run: |
          set -euxo pipefail
          ls
          make AUTO_YES=1

      - name: Verify ISO exists
        shell: msys2 {0}
        run: |
          set -euxo pipefail
          ls   -la  build/bin
          test -f   "${ISO_PATH}"
          ls   -la  "${ISO_PATH}"

      - name: Upload Artifact (bootCD.iso)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_CD_NAME }}
          path: ${{ env.ISO_PATH }}
          if-no-files-found: error
      
      # 1) Zeitstempel-Tag (Berlin-Zeit) erzeugen + pushen
      - name: Create & push timestamp tag (vYYYY_mm_dd_HH_mm)
        shell: msys2 {0}
        run: |
          set -euxo pipefail

          export TZ=Europe/Berlin
          TAG="$(date +v%Y_%m_%d_%H_%M)"

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Kollision vermeiden (z.B. Re-Run in derselben Minute)
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} existiert bereits. Bitte erneut starten (nächste Minute) oder Format erweitern."
            exit 1
          fi

          git tag -a "${TAG}" -m "Automated build ${TAG}"
          git push origin "${TAG}"

          echo "RELEASE_TAG=${TAG}" >> "$GITHUB_ENV"

      # 2) Release erstellen + ISO anhängen
      - name: Create GitHub Release + upload bootcd.iso
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "$env:RELEASE_TAG"
          if (-not $tag) { throw "RELEASE_TAG missing" }

          gh --version
          gh release create $tag "${{ env.ISO_PATH }}" `
            --title $tag `
            --generate-notes
          
      - name: Verify email recipient is set
        shell: pwsh
        env:
          NOTIFY_TO_EMAIL: ${{ secrets.NOTIFY_TO_EMAIL }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:NOTIFY_TO_EMAIL)) {
            throw "Secret NOTIFY_TO_EMAIL is missing/empty. Set it in Repo Settings -> Secrets and variables -> Actions."
          }
          
      # 3) E-Mail nur bei Erfolg (nach erfolgreichem Release)
      - name: Send email (success)
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}   # z.B. 465 oder 587
          secure: false                           # 465 meist true; bei 587 ggf. false
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}

          to: ${{ secrets.NOTIFY_TO_EMAIL }}
          from: "GitHub Actions <${{ secrets.SMTP_USERNAME }}>"
          subject: "✅ Boot ISO Release erstellt: ${{ env.RELEASE_TAG }}"
          body: |
            Build & Release erfolgreich

            Repo:  ${{ github.repository }}
            Tag:   ${{ env.RELEASE_TAG }}
            ISO:   ${{ env.ISO_PATH }}

            Run:   https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
